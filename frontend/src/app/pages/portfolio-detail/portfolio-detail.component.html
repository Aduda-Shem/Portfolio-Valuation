<app-loading-spinner *ngIf="portfolioLoading$ | async" message="Loading portfolio..."></app-loading-spinner>

<div *ngIf="!(portfolioLoading$ | async)">
  <div *ngIf="!(currentPortfolio$ | async)" class="alert alert-error">
    <span>Portfolio not found</span>
    <a routerLink="/" class="btn btn-sm">Back to Portfolios</a>
  </div>

  <div *ngIf="currentPortfolio$ | async as portfolio">
    <div class="mb-8">
      <a routerLink="/" class="text-sm text-gray-600 hover:text-gray-900 mb-4 inline-flex items-center gap-2 font-medium">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Portfolios
      </a>
      <app-card class="mb-6">
        <div class="flex items-start gap-4">
          <div class="w-16 h-16 rounded-lg bg-[#003781] flex items-center justify-center flex-shrink-0">
            <span class="text-white text-2xl font-bold">{{ portfolio.name.charAt(0) }}</span>
          </div>
          <div class="flex-1">
            <h1 class="text-2xl font-bold text-gray-900 mb-2">{{ portfolio.name }}</h1>
            <p class="text-sm text-gray-600 mb-1 font-medium">{{ portfolio.client_name }}</p>
            <p class="text-xs text-gray-500 mb-3">{{ portfolio.client_email }}</p>
            <p *ngIf="portfolio.description" class="text-sm text-gray-600">{{ portfolio.description }}</p>
          </div>
        </div>
      </app-card>
    </div>

    <!-- Holdings Section -->
    <div class="mb-8">
      <app-page-header
        title="Holdings"
        description="Manage portfolio holdings"
        [action]="true"
      >
        <app-button slot="action" (onClick)="toggleHoldingForm()">
          {{ showHoldingForm ? 'Cancel' : '+ Add Holding' }}
        </app-button>
      </app-page-header>

      <app-holding-form
        *ngIf="showHoldingForm"
        [portfolioId]="portfolioId"
        (onSubmit)="handleCreateHolding($event)"
        (onCancel)="showHoldingForm = false"
        class="mb-6"
      ></app-holding-form>

      <app-loading-spinner *ngIf="holdingsLoading$ | async" [fullHeight]="false" message="Loading holdings..."></app-loading-spinner>

      <div *ngIf="!(holdingsLoading$ | async)">
        <app-empty-state
          *ngIf="(holdings$ | async)?.length === 0"
          message="No holdings found"
          description="Add your first holding above"
        ></app-empty-state>

        <app-holdings-table
          *ngIf="(holdings$ | async)?.length! > 0"
           [holdings]="(holdings$ | async) || []"
          (onDelete)="handleDeleteHoldingClick($event)"
        ></app-holdings-table>
      </div>
    </div>

    <!-- Delete Confirmation Dialog -->
    <app-confirm-dialog
      [isOpen]="deleteConfirm.isOpen"
      title="Delete Holding"
      message="Are you sure you want to delete this holding? This action cannot be undone."
      confirmText="Delete"
      cancelText="Cancel"
      variant="danger"
      (onConfirm)="handleDeleteHoldingConfirm()"
      (onCancel)="handleDeleteHoldingCancel()"
    ></app-confirm-dialog>

    <!-- Valuations Section -->
    <div>
      <app-page-header
        title="Valuation Snapshots"
        description="Track portfolio values over time"
        [action]="true"
      >
        <div slot="action" class="flex gap-2">
          <input
            type="date"
            [(ngModel)]="valuationDate"
            class="input input-bordered input-sm bg-white border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#003781] focus:border-[#003781]"
          />
          <app-button (onClick)="handleCreateValuation()">
            Create Snapshot
          </app-button>
        </div>
      </app-page-header>

      <app-loading-spinner *ngIf="valuationsLoading$ | async" [fullHeight]="false" message="Loading valuations..."></app-loading-spinner>

      <div *ngIf="!(valuationsLoading$ | async)">
        <app-empty-state
          *ngIf="(valuations$ | async)?.length === 0"
          message="No valuation snapshots found"
          description="Create your first snapshot above"
        ></app-empty-state>

        <app-valuations-table
          *ngIf="(valuations$ | async)?.length! > 0"
           [valuations]="(valuations$ | async) || []"
          (onRecalculate)="handleRecalculate($event)"
          (onUpdateStatus)="handleUpdateStatus($event)"
        ></app-valuations-table>
      </div>
    </div>
  </div>
</div>

